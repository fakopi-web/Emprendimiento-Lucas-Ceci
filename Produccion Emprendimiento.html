<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Control de Producción</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .chart-container { position: relative; width: 100%; max-width: 800px; margin-left: auto; margin-right: auto; height: 300px; max-height: 400px; }
        @media (min-width: 768px) { .chart-container { height: 350px; } }
        .modal { transition: opacity 0.25s ease; }
        .modal-content { transition: transform 0.25s ease; }
        .table-cell { white-space: nowrap; }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            flex-direction: column; /* Allow content to stack vertically */
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* Removed display: flex from sortable-header to allow it to behave as a normal table header for alignment */
        .sortable-header {
            cursor: pointer;
            user-select: none;
            /* Flex properties are now applied to the inner div */
        }
        .sort-icon {
            margin-left: 4px;
            font-size: 0.8em;
            line-height: 1;
        }
    </style>
    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, addDoc, setDoc, updateDoc, deleteDoc, doc, getDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase instances and user state
        window.firebaseApp = null;
        window.db = null;
        window.auth = null;
        window.userId = null;
        window.isAuthReady = false; // Flag to indicate if auth is ready and userId is set

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        async function initFirebase() {
            try {
                window.firebaseApp = initializeApp(firebaseConfig);
                window.auth = getAuth(window.firebaseApp);
                window.db = getFirestore(window.firebaseApp);

                onAuthStateChanged(window.auth, async (user) => {
                    if (user) {
                        window.userId = user.uid;
                        console.log("Authenticated with Firebase UID:", window.userId);
                    } else {
                        console.log("No user signed in, attempting anonymous sign-in.");
                        try {
                            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                            if (initialAuthToken) {
                                await signInWithCustomToken(window.auth, initialAuthToken);
                            } else {
                                await signInAnonymously(window.auth);
                            }
                            window.userId = window.auth.currentUser.uid;
                            console.log("Signed in anonymously with UID:", window.userId);
                        } catch (error) {
                            console.error("Error signing in to Firebase:", error);
                            // Fallback to a random ID if anonymous sign-in fails
                            window.userId = crypto.randomUUID();
                        }
                    }
                    window.isAuthReady = true;
                    // Dispatch a custom event to signal that Firebase and auth are ready
                    document.dispatchEvent(new CustomEvent('firebaseAuthReady'));
                });
            } catch (error) {
                console.error("Error initializing Firebase:", error);
            }
        }
        initFirebase();
    </script>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="spinner"></div>
        <p id="loading-message" class="mt-4 text-gray-700">Cargando...</p>
        <button id="cancel-import-btn" class="mt-4 bg-red-500 text-white px-4 py-2 rounded-lg font-medium hidden">Cancelar</button>
    </div>

    <div id="app" class="p-4 sm:p-6 lg:p-8 max-w-7xl mx-auto">

        <header class="mb-8">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center">
                <h1 class="text-3xl font-bold text-gray-900">Panel de Control de Producción</h1>
                <div class="flex space-x-2 mt-4 sm:mt-0">
                    <button id="nav-dashboard" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium">Dashboard</button>
                    <button id="nav-prices" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium">Mantenimiento</button>
                </div>
            </div>
            <p id="header-subtitle" class="text-gray-600 mt-1">Visualiza y gestiona las novedades diarias de materiales y Producción.</p>
        </header>

        <main>
            <!-- Dashboard Section -->
            <section id="dashboard-section">
                <!-- KPIs Section -->
                <section id="kpis" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <h3 class="text-sm font-medium text-gray-500">Producción Total (KG)</h3>
                        <p id="kpi-total-kg" class="text-3xl font-bold text-gray-900 mt-2">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <h3 class="text-sm font-medium text-gray-500">Bolsas Producidas</h3>
                        <p id="kpi-bags-produced" class="text-3xl font-bold text-gray-900 mt-2">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <h3 class="text-sm font-medium text-gray-500">Bolsas Entregadas</h3>
                        <p id="kpi-bags-delivered" class="text-3xl font-bold text-gray-900 mt-2">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <h3 class="text-sm font-medium text-gray-500">Stock Estimado (Bolsas)</h3>
                        <p id="kpi-stock-bags" class="text-3xl font-bold text-gray-900 mt-2">0</p>
                    </div>
                </section>
                
                <section id="kpis-row-2" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <h3 class="text-sm font-medium text-gray-500">Valor de Producción ($)</h3>
                        <p id="kpi-total-value" class="text-3xl font-bold text-gray-900 mt-2">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <h3 class="text-sm font-medium text-gray-500">Material Ingresado (KG)</h3>
                        <p id="kpi-material-in" class="text-3xl font-bold text-gray-900 mt-2">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <h3 class="text-sm font-medium text-gray-500">Cuentas por Cobrar ($)</h3>
                        <p id="kpi-pending-payment" class="text-3xl font-bold text-gray-900 mt-2">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <h3 class="text-sm font-medium text-gray-500">Stock Est. Policarbonato (KG)</h3>
                        <p id="kpi-stock-molido" class="text-3xl font-bold text-gray-900 mt-2">0</p>
                    </div>
                </section>
                
                <!-- Expanded Production KPIs Section -->
                <section id="kpis-row-3" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <h3 class="text-sm font-medium text-gray-500">Producción Pellets (KG)</h3>
                        <p id="kpi-pellets-kg" class="text-3xl font-bold text-gray-900 mt-2">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <h3 class="text-sm font-medium text-gray-500">Producción Molido (KG)</h3>
                        <p id="kpi-molido-kg" class="text-3xl font-bold text-gray-900 mt-2">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <h3 class="text-sm font-medium text-gray-500">Producción Total ($)</h3>
                        <p id="kpi-total-value-produced" class="text-3xl font-bold text-gray-900 mt-2">0</p>
                    </div>
                </section>

                <!-- Filters and Charts Section -->
                <section class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 mb-8">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
                        <h2 class="text-xl font-bold text-gray-900 mb-4 sm:mb-0">Análisis de Novedades</h2>
                        <div id="time-filters" class="flex flex-wrap items-center space-x-2 space-y-2 sm:space-y-0">
                            <button data-filter="week" class="filter-btn bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium">Últimos 7 días</button>
                            <button data-filter="month" class="filter-btn bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium">Este Mes</button>
                            <button data-filter="month-specific" class="filter-btn bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium">Por Mes</button>
                            <button data-filter="all" class="filter-btn bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium">Todos</button>
                            <select id="month-select" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium"></select>
                            <select id="product-select" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium"></select>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div>
                            <h3 class="text-lg font-semibold text-center mb-2">Producción (KG) por Producto</h3>
                            <p class="text-sm text-gray-500 text-center mb-4">Compara la cantidad total producida de cada línea de producto.</p>
                            <div class="chart-container h-80 md:h-96">
                                <canvas id="productionByProductChart"></canvas>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-center mb-2">Valor ($) por Producto</h3>
                            <p class="text-sm text-gray-500 text-center mb-4">Distribución del valor monetario generado por cada producto.</p>
                            <div class="chart-container h-80 md:h-96">
                                <canvas id="valueByProductChart"></canvas>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Data Table Section -->
                <section id="data-table-section" class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
                        <h2 class="text-xl font-bold text-gray-900">Registro de Novedades</h2>
                        <div class="flex items-center space-x-2 mt-2 sm:mt-0">
                            <button id="refresh-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium">Refrescar</button>
                            <input type="file" id="csv-file" class="hidden" accept=".csv">
                            <button id="import-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium">Importar CSV</button>
                            <button id="export-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium">Exportar CSV</button>
                            <button id="generate-ideas-btn" class="bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-medium ml-2">Generar Ideas ✨</button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" data-sort-by="fecha"><div class="flex items-center">Fecha <span class="sort-icon"></span></div></th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" data-sort-by="tipo"><div class="flex items-center">Tipo <span class="sort-icon"></span></div></th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" data-sort-by="producto"><div class="flex items-center">Producto/Línea <span class="sort-icon"></span></div></th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Cantidad</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">KG Netos</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Bolsas (25kg)</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">$ en Pesos</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Indicador</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="novedades-table-body" class="bg-white divide-y divide-gray-200">
                            </tbody>
                        </table>
                    </div>
                </section>
            </section>
            
            <!-- Prices and Notifications Maintenance Section -->
            <section id="prices-section" class="hidden">
                <!-- Prices Section -->
                <section class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 mb-8">
                    <h2 class="text-xl font-bold text-gray-900 mb-4">Mantenimiento de Precios y Factores</h2>
                    <p class="text-sm text-gray-600 mb-6">Aquí puedes actualizar los valores de conversión para los productos. Los cambios afectarán los cálculos futuros.</p>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Producto</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Factor de Conversión (KG)</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Precio por KG ($)</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="prices-table-body" class="bg-white divide-y divide-gray-200">
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- General Configuration Section -->
                <section class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 mb-8">
                    <h2 class="text-xl font-bold text-gray-900 mb-4">Configuración General</h2>
                    <p class="text-sm text-gray-600 mb-6">Puedes ajustar el peso de las bolsas de Pellets desde aquí. (Peso de la bolsa sin incluir la tara)</p>
                    <div class="flex items-center space-x-4">
                        <label for="bolsa-peso" class="block text-sm font-medium text-gray-700">Peso de la Bolsa de Pellets (Kg)</label>
                        <input type="number" id="bolsa-peso" step="0.01" class="w-24 px-3 py-2 border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <button id="save-bolsa-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium">Guardar</button>
                    </div>
                </section>

                <!-- Notification Audit Section -->
                <section class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 mb-8">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-gray-900">Auditoría de Acciones</h2>
                        <button id="clear-audit-btn" class="bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-medium">Limpiar Historial</button>
                    </div>
                    <p class="text-sm text-gray-600 mb-4">Registro de todas las acciones de creación, edición y eliminación de registros.</p>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Asunto</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Detalles</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="audit-table-body" class="bg-white divide-y divide-gray-200">
                            </tbody>
                        </table>
                    </div>
                </section>
            </section>
        </main>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0">
        <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-sm p-8 transform -translate-y-10">
            <h2 class="text-xl font-bold mb-4">Confirmar Eliminación</h2>
            <p class="text-gray-700 mb-6">¿Estás seguro de que deseas eliminar este registro? Esta acción no se puede deshacer.</p>
            <div class="flex justify-end space-x-4">
                <button id="confirm-cancel-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-medium">Cancelar</button>
                <button id="confirm-delete-btn" class="bg-red-600 text-white px-4 py-2 rounded-lg font-medium">Eliminar</button>
            </div>
        </div>
    </div>
    
    <!-- Add/Edit Modal (for novedades) -->
    <div id="novedad-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0">
        <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-lg p-8 transform -translate-y-10">
            <h2 id="modal-title" class="text-2xl font-bold mb-6">Nueva Novedad</h2>
            <form id="novedad-form">
                <input type="hidden" id="novedad-id">
                <input type="hidden" id="novedad-firestore-id"> <!-- New field for Firestore ID -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                    <div>
                        <label for="fecha" class="block text-sm font-medium text-gray-700">Fecha</label>
                        <input type="date" id="fecha" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="tipo" class="block text-sm font-medium text-gray-700">Tipo</label>
                        <select id="tipo" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></select>
                    </div>
                    <div class="sm:col-span-2">
                        <label for="producto" class="block text-sm font-medium text-gray-700">Producto o Línea</label>
                        <select id="producto" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></select>
                    </div>
                    <div>
                        <label for="cantidad" class="block text-sm font-medium text-gray-700">Cantidad / Kg / Pesos</label>
                        <input type="number" id="cantidad" step="0.01" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="operarios" class="block text-sm font-medium text-gray-700">Operarios</label>
                        <input type="number" id="operarios" value="0" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="sm:col-span-2">
                        <label for="comentarios" class="block text-sm font-medium text-gray-700">Comentarios</label>
                        <textarea id="comentarios" rows="3" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                    </div>
                </div>
                <div class="mt-8 flex justify-end space-x-4">
                    <button type="button" id="novedad-cancel-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-medium">Cancelar</button>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Price Modal -->
    <div id="price-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0">
        <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-sm p-8 transform -translate-y-10">
            <h2 class="text-2xl font-bold mb-6">Editar Producto</h2>
            <form id="price-form">
                <input type="hidden" id="price-product-name">
                <div class="mb-4">
                    <label for="price-kg-factor" class="block text-sm font-medium text-gray-700">Factor de Conversión (KG)</label>
                    <input type="number" id="price-kg-factor" step="0.01" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="mb-4">
                    <label for="price-price-per-kg" class="block text-sm font-medium text-gray-700">Precio por KG ($)</label>
                    <input type="number" id="price-price-per-kg" step="0.01" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="mt-8 flex justify-end space-x-4">
                    <button type="button" id="price-cancel-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-medium">Cancelar</button>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium">Guardar</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Password Prompt Modal -->
    <div id="password-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0">
        <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-sm p-8 transform -translate-y-10">
            <h2 class="text-xl font-bold mb-4">Ingresar Contraseña</h2>
            <p class="text-gray-700 mb-6">Esta acción requiere una clave de seguridad. La clave es `1234`.</p>
            <input type="password" id="password-input" class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 mb-4" placeholder="Clave de seguridad">
            <div class="flex justify-end space-x-4">
                <button id="password-cancel-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-medium">Cancelar</button>
                <button id="password-confirm-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- LLM Output / Message Modal -->
    <div id="llm-output-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0">
        <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-md p-8 transform -translate-y-10">
            <h2 id="llm-output-title" class="text-2xl font-bold mb-4">Mensaje</h2>
            <p id="llm-output-text" class="text-gray-700 mb-6"></p>
            <div class="flex justify-end">
                <button id="llm-output-ok-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium">OK</button>
            </div>
        </div>
    </div>

    <!-- Add Button -->
    <button id="add-btn" class="fixed bottom-8 right-8 bg-blue-600 text-white rounded-full p-4 shadow-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg>
    </button>
    
    <script type="module">
        import { collection, query, onSnapshot, addDoc, setDoc, updateDoc, deleteDoc, doc, getDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase instances and user state
        let novedades = [];
        let productConfig = {};
        let auditLog = [];
        let bolsaPeso = 25; 
        
        let currentFilter = 'month-specific'; 
        let selectedMonth = new Date().toISOString().slice(0, 7);
        let selectedProduct = 'all'; // New state variable for product filter

        // State for sorting
        let currentSortColumn = 'fecha'; // Default sort column
        let currentSortDirection = 'desc'; // Default sort direction (descending for dates)

        let productionByProductChart, valueByProductChart;
        let deleteId = null;
        let deleteType = null; // 'novedad' or 'audit'
        let deleteFirestoreId = null; // To store Firestore ID for delete operations
        let cancelImport = false; // New flag to control import cancellation

        const AUDIT_PASSWORD = '1234';

        const options = {
            tipo: {
                'Producción Diurna': ['Pellets', 'Molido Policarbonato'],
                'Producción Nocturna': ['Pellets', 'Molido Policarbonato'],
                'Novedades Diurna': ['Bidones 12L', 'Bidones 20L', 'Tapas'],
                'Novedades Nocturna': ['Bidones 12L', 'Bidones 20L', 'Tapas'],
                'Egreso Producción': ['Egreso Pellets', 'Egreso Molido Policarbonato'],
                'Pendiente de Cobro': ['Pendiente de Cobro'],
                'Cobro de Pendiente': ['Cobro de Pendiente'],
            }
        };

        const formatCurrency = (value) => new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS' }).format(value);
        const formatNumber = (value) => new Intl.NumberFormat('es-AR').format(value);
        const getMonthName = (monthIndex) => ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'][monthIndex];

        // Renamed from showMessage to showLLMOutput to reflect its primary use, but still versatile
        const showLLMOutput = (title, message) => {
            document.getElementById('llm-output-title').textContent = title;
            document.getElementById('llm-output-text').innerHTML = message;
            openModal(document.getElementById('llm-output-modal'));
        };

        const calculateFields = (novedad) => {
            let kgNetos = 0;
            let valor = 0;
            let indicador = 'N'; // Default to N
            let bolsas = 0;

            const { tipo, producto, cantidad } = novedad;
            const config = productConfig[producto] || { kgFactor: 0, pricePerKg: 0 };
            
            if (producto.includes('Pellets') && tipo.includes('Producción')) {
                kgNetos = cantidad;
                bolsas = kgNetos / bolsaPeso;
            } else if (producto.includes('Egreso Pellets')) {
                kgNetos = cantidad;
                bolsas = kgNetos / bolsaPeso;
            } else {
                kgNetos = cantidad * config.kgFactor;
                bolsas = 0; 
            }
            
            if (tipo === 'Pendiente de Cobro' || tipo === 'Cobro de Pendiente') {
                valor = cantidad;
            } else {
                valor = kgNetos * config.pricePerKg;
            }
            
            if (tipo.includes('Producción')) { // This covers both Diurna and Nocturna
                indicador = 'P';
            } else if (tipo.includes('Egreso')) {
                indicador = 'E';
            } else {
                indicador = 'N';
            }

            return { ...novedad, kgNetos, valor, indicador, bolsas };
        };

        const getCollectionPath = (collectionName) => {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            return `artifacts/${appId}/users/${window.userId}/${collectionName}`;
        };

        // --- Firestore Operations ---
        const saveNovedadToFirestore = async (novedad) => {
            if (!window.db || !window.userId) return;
            const novedadesColRef = collection(window.db, getCollectionPath('novedades_collection'));
            const { firestoreId, ...dataToSave } = novedad; 
            if (firestoreId) {
                // Corrected: doc(collectionRef, documentId)
                await updateDoc(doc(novedadesColRef, firestoreId), dataToSave);
            } else {
                await addDoc(novedadesColRef, dataToSave);
            }
        };

        const deleteNovedadFromFirestore = async (firestoreId) => {
            if (!window.db || !window.userId) return;
            const novedadesColRef = collection(window.db, getCollectionPath('novedades_collection'));
            // Corrected: doc(collectionRef, documentId)
            await deleteDoc(doc(novedadesColRef, firestoreId));
        };

        const saveProductConfigToFirestore = async () => {
            if (!window.db || !window.userId) return;
            const configDocRef = doc(window.db, getCollectionPath('product_config_collection'), 'settings');
            await setDoc(configDocRef, { config: productConfig, bolsaPeso: bolsaPeso });
        };

        const logActionToFirestore = async (type, details) => {
            if (!window.db || !window.userId) return;
            const auditColRef = collection(window.db, getCollectionPath('audit_log_collection'));
            const timestamp = new Date().toISOString();
            let subject;
            let logDetails = { ...details };

            if (type === 'new' || type === 'delete') {
                const processedDetails = calculateFields(details);
                logDetails = { ...logDetails, kgNetos: processedDetails.kgNetos, valor: processedDetails.valor, indicador: processedDetails.indicador, bolsas: processedDetails.bolsas };
            } else if (type === 'edit') {
                subject = `Registro modificado`;
                const processedOld = calculateFields(details.old);
                const processedNew = calculateFields(details.new);
                logDetails = {
                    old: { ...details.old, kgNetos: processedOld.kgNetos, valor: processedOld.valor, indicador: processedOld.indicador, bolsas: processedOld.bolsas },
                    new: { ...details.new, kgNetos: processedNew.kgNetos, valor: processedNew.valor, indicador: processedNew.indicador, bolsas: processedNew.bolsas }
                };
            }
            if (type === 'new') subject = `Registro añadido`;
            if (type === 'delete') subject = `Registro eliminado`;

            await addDoc(auditColRef, {
                timestamp,
                type,
                subject,
                details: logDetails
            });
        };

        const deleteAuditLogFromFirestore = async (firestoreId) => {
            if (!window.db || !window.userId) return;
            const auditColRef = collection(window.db, getCollectionPath('audit_log_collection'));
            // Corrected: doc(collectionRef, documentId)
            await deleteDoc(doc(auditColRef, firestoreId));
        };

        const clearAllAuditLogsFromFirestore = async () => {
            if (!window.db || !window.userId) return;
            const auditColRef = collection(window.db, getCollectionPath('audit_log_collection'));
            const q = query(auditColRef);
            const querySnapshot = await getDocs(q); // Use getDocs for a one-time fetch to delete
            const deletePromises = [];
            querySnapshot.forEach((document) => {
                deletePromises.push(deleteDoc(document.ref));
            });
            await Promise.all(deletePromises);
        };
        // --- End Firestore Operations ---

        const renderNovedadesTable = (data) => {
            const tableBody = document.getElementById('novedades-table-body');
            tableBody.innerHTML = data.map(n => {
                const processed = calculateFields(n);
                const bolsasDisplay = processed.bolsas ? formatNumber(processed.bolsas.toFixed(2)) : '-';
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 table-cell">${new Date(n.fecha + 'T00:00:00').toLocaleDateString('es-AR')}</td>
                        <td class="px-4 py-3 table-cell">${n.tipo}</td>
                        <td class="px-4 py-3 table-cell">${n.producto}</td>
                        <td class="px-4 py-3 table-cell text-right">${formatNumber(n.cantidad)}</td>
                        <td class="px-4 py-3 table-cell text-right">${formatNumber(processed.kgNetos)}</td>
                        <td class="px-4 py-3 table-cell text-right">${bolsasDisplay}</td>
                        <td class="px-4 py-3 table-cell text-right">${formatCurrency(processed.valor)}</td>
                        <td class="px-4 py-3 table-cell text-center">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${processed.indicador === 'P' ? 'bg-green-100 text-green-800' : processed.indicador === 'E' ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800'}">
                                ${processed.indicador}
                            </span>
                        </td>
                        <td class="px-4 py-3 table-cell text-center">
                            <button class="edit-btn text-blue-600 hover:text-blue-900" data-id="${n.id}" data-firestore-id="${n.firestoreId}">Editar</button>
                            <button class="delete-btn text-red-600 hover:text-red-900 ml-2" data-id="${n.id}" data-firestore-id="${n.firestoreId}">Eliminar</button>
                        </td>
                    </tr>
                `;
            }).join('');

            // Update sort icons
            document.querySelectorAll('.sortable-header').forEach(header => {
                const sortBy = header.dataset.sortBy;
                const sortIcon = header.querySelector('.sort-icon');
                if (sortBy === currentSortColumn) {
                    sortIcon.textContent = currentSortDirection === 'asc' ? '▲' : '▼';
                } else {
                    sortIcon.textContent = ''; // Clear icon if not sorted by this column
                }
            });
        };

        const renderPriceTable = () => {
            const tableBody = document.getElementById('prices-table-body');
            const productsToDisplay = Object.keys(productConfig).filter(p => !p.startsWith('Egreso') && !p.includes('Cobro'));
            tableBody.innerHTML = productsToDisplay.map(p => {
                const config = productConfig[p];
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 table-cell">${p}</td>
                        <td class="px-4 py-3 table-cell text-right">${config.kgFactor}</td>
                        <td class="px-4 py-3 table-cell text-right">${formatCurrency(config.pricePerKg)}</td>
                        <td class="px-4 py-3 table-cell text-center">
                            <button class="edit-price-btn text-blue-600 hover:text-blue-900" data-product="${p}">Editar</button>
                        </td>
                    </tr>
                `;
            }).join('');
        };

        const renderAuditTable = () => {
            const auditTableBody = document.getElementById('audit-table-body');
            auditTableBody.innerHTML = auditLog.map(log => `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3 table-cell">${new Date(log.timestamp).toLocaleString('es-AR')}</td>
                    <td class="px-4 py-3 table-cell">${log.type}</td>
                    <td class="px-4 py-3 table-cell">${log.subject}</td>
                    <td class="px-4 py-3 table-cell overflow-hidden max-w-xs">
                        <pre class="text-xs p-1 bg-gray-100 rounded-md overflow-x-auto">${JSON.stringify(log.details, null, 2)}</pre>
                    </td>
                    <td class="px-4 py-3 table-cell text-center">
                        <button class="delete-audit-btn text-red-600 hover:text-red-900" data-id="${log.id}" data-firestore-id="${log.firestoreId}">Eliminar</button>
                    </td>
                </tr>
            `).join('');
        };

        const renderKPIs = (data) => {
            const processedData = data.map(calculateFields);
            const totalKg = processedData.filter(n => n.tipo.includes('Producción')).reduce((sum, n) => sum + n.kgNetos, 0);
            const totalValue = processedData.filter(n => n.tipo.includes('Producción')).reduce((sum, n) => sum + n.valor, 0);
            const materialIn = processedData.filter(n => n.tipo.includes('Novedades')).reduce((sum, n) => sum + n.kgNetos, 0);
            const pendingPayment = processedData.reduce((sum, n) => {
                if (n.tipo === 'Pendiente de Cobro') return sum + n.valor;
                if (n.tipo === 'Cobro de Pendiente') return sum - n.valor;
                return sum;
            }, 0);
            
            const bagsProduced = processedData.filter(n => n.tipo.includes('Producción') && n.producto === 'Pellets').reduce((sum, n) => sum + n.bolsas, 0);
            const bagsDelivered = processedData.filter(n => n.tipo.includes('Egreso') && n.producto === 'Egreso Pellets').reduce((sum, n) => sum + (n.cantidad / bolsaPeso), 0);
            const stockBags = bagsProduced - bagsDelivered;
            
            const totalKgPellets = processedData.filter(n => n.tipo.includes('Producción') && n.producto === 'Pellets').reduce((sum, n) => sum + n.kgNetos, 0);
            const totalKgMolido = processedData.filter(n => n.tipo.includes('Producción') && n.producto === 'Molido Policarbonato').reduce((sum, n) => sum + n.kgNetos, 0);
            const molidoProduced = processedData.filter(n => n.tipo.includes('Producción') && n.producto === 'Molido Policarbonato').reduce((sum, n) => sum + n.kgNetos, 0);
            const molidoDelivered = processedData.filter(n => n.tipo.includes('Egreso') && n.producto === 'Egreso Molido Policarbonato').reduce((sum, n) => sum + n.kgNetos, 0);
            const molidoStock = molidoProduced - molidoDelivered;


            document.getElementById('kpi-total-kg').textContent = formatNumber(totalKg);
            document.getElementById('kpi-total-value').textContent = formatCurrency(totalValue);
            document.getElementById('kpi-material-in').textContent = formatNumber(materialIn);
            document.getElementById('kpi-pending-payment').textContent = formatCurrency(pendingPayment);
            
            document.getElementById('kpi-bags-produced').textContent = formatNumber(bagsProduced.toFixed(2));
            document.getElementById('kpi-bags-delivered').textContent = formatNumber(bagsDelivered.toFixed(2));
            document.getElementById('kpi-stock-bags').textContent = formatNumber(stockBags.toFixed(2));

            document.getElementById('kpi-stock-molido').textContent = formatNumber(molidoStock.toFixed(2));
            document.getElementById('kpi-pellets-kg').textContent = formatNumber(totalKgPellets);
            document.getElementById('kpi-molido-kg').textContent = formatNumber(totalKgMolido);
            document.getElementById('kpi-total-value-produced').textContent = formatCurrency(totalValue);
        };

        const renderCharts = (data) => {
            const processedData = data.map(calculateFields).filter(n => n.tipo.includes('Producción'));
            
            const productionByProduct = processedData.reduce((acc, n) => {
                acc[n.producto] = (acc[n.producto] || 0) + n.kgNetos;
                return acc;
            }, {});

            const valueByProduct = processedData.reduce((acc, n) => {
                acc[n.producto] = (acc[n.producto] || 0) + n.valor;
                return acc;
            }, {});

            const chartColors = ['#3b82f6', '#10b981', '#f97316', '#8b5cf6', '#d946ef', '#f43f5e'];

            const prodCtx = document.getElementById('productionByProductChart').getContext('2d');
            if (productionByProductChart) productionByProductChart.destroy();
            productionByProductChart = new Chart(prodCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(productionByProduct),
                    datasets: [{
                        label: 'Producción (KG)',
                        data: Object.values(productionByProduct),
                        backgroundColor: chartColors,
                        borderColor: chartColors.map(c => c + 'B3'),
                        borderWidth: 1
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });

            const valueCtx = document.getElementById('valueByProductChart').getContext('2d');
            if (valueByProductChart) valueByProductChart.destroy();
            valueByProductChart = new Chart(valueCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(valueByProduct),
                    datasets: [{
                        data: Object.values(valueByProduct),
                        backgroundColor: chartColors,
                        hoverOffset: 4
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        };

        const populateMonthSelect = () => {
            const monthSelect = document.getElementById('month-select');
            monthSelect.innerHTML = '';
            // Use the full 'novedades' array, not the filtered one, to get all available months
            const availableMonths = [...new Set(novedades.map(n => n.fecha.slice(0, 7)))].sort().reverse();
            availableMonths.forEach(month => {
                const date = new Date(`${month}-01T00:00:00`);
                const option = document.createElement('option');
                option.value = month;
                option.textContent = `${getMonthName(date.getMonth())} ${date.getFullYear()}`;
                monthSelect.appendChild(option);
            });
            // Ensure the selected month is valid, default to current if not found
            if (!availableMonths.includes(selectedMonth)) {
                selectedMonth = new Date().toISOString().slice(0, 7);
            }
            monthSelect.value = selectedMonth;
        };

        const populateProductSelect = () => {
            const productSelect = document.getElementById('product-select');
            productSelect.innerHTML = '<option value="all">Todos los Productos</option>'; // Default option
            const availableProducts = [...new Set(novedades.map(n => n.producto))].sort();
            availableProducts.forEach(product => {
                const option = document.createElement('option');
                option.value = product;
                option.textContent = product;
                productSelect.appendChild(option);
            });
            productSelect.value = selectedProduct;
        };

        const filterAndSortData = () => {
            const now = new Date();
            let processedNovedades = novedades;

            // Apply time filter
            if (currentFilter === 'week') {
                const filterDate = new Date(now);
                filterDate.setDate(now.getDate() - 7);
                processedNovedades = processedNovedades.filter(n => new Date(n.fecha) >= filterDate);
            } else if (currentFilter === 'month') {
                const filterDate = new Date(now.getFullYear(), now.getMonth(), 1);
                processedNovedades = processedNovedades.filter(n => new Date(n.fecha) >= filterDate);
            } else if (currentFilter === 'month-specific') {
                processedNovedades = processedNovedades.filter(n => n.fecha.startsWith(selectedMonth));
            }
            // 'all' filter uses the unfiltered 'novedades' directly

            // Apply product filter
            if (selectedProduct !== 'all') {
                processedNovedades = processedNovedades.filter(n => n.producto === selectedProduct);
            }

            // Apply sorting
            processedNovedades.sort((a, b) => {
                let valA = a[currentSortColumn];
                let valB = b[currentSortColumn];

                if (currentSortColumn === 'fecha') {
                    valA = new Date(valA);
                    valB = new Date(valB);
                }

                if (valA < valB) return currentSortDirection === 'asc' ? -1 : 1;
                if (valA > valB) return currentSortDirection === 'asc' ? 1 : -1;
                return 0;
            });

            return processedNovedades;
        };
        
        const refreshUI = () => {
            const dataToDisplay = filterAndSortData();
            renderNovedadesTable(dataToDisplay);
            renderKPIs(dataToDisplay); // KPIs now use filtered and sorted data
            renderCharts(dataToDisplay); // Charts use filtered and sorted data
            renderPriceTable();
            renderAuditTable();
            document.getElementById('bolsa-peso').value = bolsaPeso;
            populateMonthSelect(); // Re-populate month select to reflect new data
            populateProductSelect(); // Re-populate product select to reflect new data
        };

        const novedadModal = document.getElementById('novedad-modal');
        const novedadForm = document.getElementById('novedad-form');
        const tipoSelect = document.getElementById('tipo');
        const productoSelect = document.getElementById('producto');
        const confirmModal = document.getElementById('confirm-modal');
        const passwordModal = document.getElementById('password-modal');
        const passwordInput = document.getElementById('password-input');
        // Renamed from messageModal to llmOutputModal
        const llmOutputModal = document.getElementById('llm-output-modal');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingMessage = document.getElementById('loading-message');
        const cancelImportBtn = document.getElementById('cancel-import-btn');

        const showLoading = (message = 'Cargando...') => {
            loadingMessage.textContent = message;
            cancelImportBtn.classList.add('hidden'); // Hide by default for general loading
            loadingOverlay.classList.remove('hidden');
            setTimeout(() => {
                loadingOverlay.classList.remove('opacity-0');
            }, 10);
        };

        const showImportLoading = (message = 'Importando datos...') => {
            showLoading(message);
            cancelImportBtn.classList.remove('hidden'); // Show cancel button for import
        };

        const hideLoading = () => {
            loadingOverlay.classList.add('opacity-0');
            setTimeout(() => loadingOverlay.classList.add('hidden'), 250);
            cancelImport = false; // Reset cancel flag when loading is hidden
        };


        const openModal = (modal) => {
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modal.querySelector('.modal-content').classList.remove('-translate-y-10');
            }, 10);
        };

        const closeModal = (modal) => {
            modal.classList.add('opacity-0');
            modal.querySelector('.modal-content').classList.add('-translate-y-10');
            setTimeout(() => modal.classList.add('hidden'), 250);
        };
        
        const openNovedadModal = (novedad = null) => {
            novedadForm.reset();
            document.getElementById('novedad-id').value = '';
            document.getElementById('novedad-firestore-id').value = ''; // Clear firestoreId field
            if (novedad) {
                document.getElementById('modal-title').textContent = 'Editar Novedad';
                document.getElementById('novedad-id').value = novedad.id;
                document.getElementById('novedad-firestore-id').value = novedad.firestoreId; // Set firestoreId
                document.getElementById('fecha').value = novedad.fecha;
                tipoSelect.value = novedad.tipo;
                updateProductoOptions();
                productoSelect.value = novedad.producto;
                document.getElementById('cantidad').value = novedad.cantidad;
                document.getElementById('operarios').value = novedad.operarios;
                document.getElementById('comentarios').value = novedad.comentarios;
            } else {
                document.getElementById('modal-title').textContent = 'Nueva Novedad';
                document.getElementById('fecha').valueAsDate = new Date();
            }
            openModal(novedadModal);
        };

        const openConfirmModal = () => openModal(confirmModal);
        const closeConfirmModal = () => closeModal(confirmModal);

        const openPasswordModal = (actionType) => {
            passwordInput.value = '';
            passwordInput.dataset.action = actionType;
            openModal(passwordModal);
        };
        const closePasswordModal = () => closeModal(passwordModal);
        
        // Renamed from message-ok-btn to llm-output-ok-btn
        document.getElementById('llm-output-ok-btn').addEventListener('click', () => closeModal(llmOutputModal));

        // Event listener for the new cancel import button
        cancelImportBtn.addEventListener('click', () => {
            cancelImport = true;
            loadingMessage.textContent = 'Cancelando importación... Por favor, espera.';
            cancelImportBtn.classList.add('hidden'); // Hide the button once clicked
        });


        const updateProductoOptions = () => {
            const selectedTipo = tipoSelect.value;
            const productos = options.tipo[selectedTipo] || [];
            productoSelect.innerHTML = productos.map(p => `<option value="${p}">${p}</option>`).join('');
        };

        Object.keys(options.tipo).forEach(tipo => {
            tipoSelect.innerHTML += `<option value="${tipo}">${tipo}</option>`;
        });
        updateProductoOptions();

        tipoSelect.addEventListener('change', updateProductoOptions);
        document.getElementById('add-btn').addEventListener('click', () => openNovedadModal());
        document.getElementById('novedad-cancel-btn').addEventListener('click', () => closeModal(novedadModal));
        
        novedadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('novedad-id').value;
            const firestoreId = document.getElementById('novedad-firestore-id').value; // Get firestoreId from new field
            const oldNovedad = firestoreId ? novedades.find(n => n.firestoreId === firestoreId) : null;
            
            const newNovedad = {
                id: id ? parseInt(id) : Date.now(),
                fecha: document.getElementById('fecha').value,
                tipo: tipoSelect.value,
                producto: productoSelect.value,
                cantidad: parseFloat(document.getElementById('cantidad').value),
                operarios: parseInt(document.getElementById('operarios').value),
                comentarios: document.getElementById('comentarios').value,
            };

            showLoading();
            try {
                if (firestoreId) {
                    await saveNovedadToFirestore({ ...newNovedad, firestoreId });
                    logActionToFirestore('edit', { old: oldNovedad, new: newNovedad });
                } else {
                    await saveNovedadToFirestore(newNovedad);
                    logActionToFirestore('new', newNovedad);
                }
            } catch (error) {
                console.error("Error al guardar novedad en Firestore:", error);
                showLLMOutput('Error', 'Hubo un error al guardar la novedad. Inténtalo de nuevo.');
            } finally {
                hideLoading();
                closeModal(novedadModal);
            }
        });

        document.getElementById('novedades-table-body').addEventListener('click', (e) => {
            const target = e.target;
            if (target.classList.contains('edit-btn')) {
                const id = parseInt(target.dataset.id);
                const firestoreId = target.dataset.firestoreId;
                const novedadToEdit = novedades.find(n => n.firestoreId === firestoreId);
                openNovedadModal(novedadToEdit);
            }
            if (target.classList.contains('delete-btn')) {
                deleteId = parseInt(target.dataset.id);
                deleteType = 'novedad';
                deleteFirestoreId = target.dataset.firestoreId; // Store firestore ID for deletion
                openConfirmModal();
            }
        });

        // Event listener for sorting headers
        document.querySelector('#data-table-section thead').addEventListener('click', (e) => {
            const header = e.target.closest('.sortable-header');
            if (header) {
                const sortBy = header.dataset.sortBy;
                if (currentSortColumn === sortBy) {
                    currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSortColumn = sortBy;
                    currentSortDirection = 'asc'; // Default to ascending when changing column
                    if (currentSortColumn === 'fecha') { // Dates often make more sense descending by default
                        currentSortDirection = 'desc';
                    }
                }
                refreshUI();
            }
        });


        document.getElementById('audit-table-body').addEventListener('click', (e) => {
            const target = e.target;
            if (target.classList.contains('delete-audit-btn')) {
                deleteId = parseInt(target.dataset.id);
                deleteType = 'audit-individual';
                deleteFirestoreId = target.dataset.firestoreId; // Store firestore ID for deletion
                openPasswordModal(deleteType);
            }
        });

        document.getElementById('clear-audit-btn').addEventListener('click', () => {
            openPasswordModal('audit-all');
        });

        document.getElementById('confirm-delete-btn').addEventListener('click', async () => {
            if (deleteType === 'novedad') {
                if (deleteFirestoreId !== null) {
                    showLoading();
                    try {
                        const deletedNovedad = novedades.find(n => n.firestoreId === deleteFirestoreId);
                        await deleteNovedadFromFirestore(deleteFirestoreId);
                        logActionToFirestore('delete', deletedNovedad);
                    } catch (error) {
                        console.error("Error al eliminar novedad de Firestore:", error);
                        showLLMOutput('Error', 'Hubo un error al eliminar la novedad. Inténtalo de nuevo.');
                    } finally {
                        hideLoading();
                        closeConfirmModal();
                        deleteId = null;
                        deleteType = null;
                        deleteFirestoreId = null;
                    }
                }
            }
        });

        document.getElementById('confirm-cancel-btn').addEventListener('click', () => {
            closeConfirmModal();
            deleteId = null;
            deleteType = null;
            deleteFirestoreId = null;
        });
        
        passwordInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('password-confirm-btn').click();
            }
        });

        document.getElementById('password-confirm-btn').addEventListener('click', async () => {
            const enteredPassword = passwordInput.value;
            const action = passwordInput.dataset.action;
            if (enteredPassword === AUDIT_PASSWORD) {
                showLoading();
                try {
                    if (action === 'audit-individual' && deleteFirestoreId !== null) {
                        await deleteAuditLogFromFirestore(deleteFirestoreId);
                    } else if (action === 'audit-all') {
                        await clearAllAuditLogsFromFirestore();
                    }
                } catch (error) {
                    console.error("Error al gestionar auditoría en Firestore:", error);
                    showLLMOutput('Error', 'Hubo un error al gestionar el historial de auditoría. Inténtalo de nuevo.');
                } finally {
                    hideLoading();
                    closePasswordModal();
                    deleteId = null;
                    deleteType = null;
                    deleteFirestoreId = null;
                }
            } else {
                showLLMOutput('Clave Incorrecta', 'La clave ingresada no es correcta. Por favor, inténtalo de nuevo.');
            }
        });

        document.getElementById('password-cancel-btn').addEventListener('click', closePasswordModal);

        document.getElementById('time-filters').addEventListener('click', (e) => {
            const target = e.target;
            if (target.tagName === 'BUTTON') {
                currentFilter = target.dataset.filter;
                document.querySelectorAll('#time-filters .filter-btn').forEach(btn => {
                    btn.classList.remove('bg-blue-600', 'text-white');
                    btn.classList.add('bg-gray-200', 'text-gray-700');
                });
                target.classList.add('bg-blue-600', 'text-white');
                target.classList.remove('bg-gray-200', 'text-gray-700');
                document.getElementById('month-select').classList.add('hidden');
                if (currentFilter === 'month-specific') {
                    document.getElementById('month-select').classList.remove('hidden');
                    populateMonthSelect();
                }
                refreshUI();
            }
        });

        document.getElementById('month-select').addEventListener('change', (e) => {
            selectedMonth = e.target.value;
            refreshUI();
        });

        document.getElementById('product-select').addEventListener('change', (e) => {
            selectedProduct = e.target.value;
            refreshUI();
        });

        // CSV Import/Export Logic
        const exportToCsv = () => {
            const headers = ['id', 'fecha', 'tipo', 'producto', 'cantidad', 'operarios', 'comentarios'];
            const rows = novedades.map(n => {
                const formattedComments = `"${(n.comentarios || '').replace(/"/g, '""')}"`;
                return [
                    n.id,
                    n.fecha,
                    n.tipo,
                    n.producto,
                    n.cantidad,
                    n.operarios,
                    formattedComments
                ].join(',');
            });

            const csvContent = "data:text/csv;charset=utf-8," + headers.join(',') + "\n" + rows.join('\n');
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "novedades.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        const importFromCsv = (file) => {
            const reader = new FileReader();
            reader.onload = async (e) => {
                showImportLoading('Preparando importación...'); // Mostrar la capa de carga con botón de cancelar
                cancelImport = false; // Reset the cancel flag at the start of import
                let successfullyProcessedLines = 0; // Track lines successfully processed before Firestore commit
                let novedadesToCommit = []; // Store validated novelties here

                try {
                    const content = e.target.result;
                    const lines = content.split(/\r?\n/).filter(line => line.trim() !== '');
                    const importErrors = [];
                    
                    const expectedHeaders = ['id', 'fecha', 'tipo', 'producto', 'cantidad', 'operarios', 'comentarios'];
                    const headerLine = lines[0].toLowerCase().split(',').map(h => h.trim());
                    const headerMap = {};
                    expectedHeaders.forEach((h, i) => headerMap[h] = headerLine.indexOf(h)); // Map expected headers to actual column indices
                    
                    const hasValidHeaders = expectedHeaders.every(h => headerMap[h] !== -1);

                    if (lines.length <= 1 || !hasValidHeaders) {
                        showLLMOutput('Importación Fallida', 'El archivo no tiene un formato CSV válido o le faltan las columnas esperadas (id, fecha, tipo, producto, cantidad, operarios, comentarios).');
                        return; 
                    }
                    
                    for (let i = 1; i < lines.length; i++) {
                        if (cancelImport) { // Check for cancellation flag in each iteration
                            console.log(`Importación cancelada por el usuario en la línea ${i}.`);
                            break; // Exit loop immediately
                        }
                        loadingMessage.textContent = `Importando línea ${i} de ${lines.length - 1}...`;

                        const line = lines[i];
                        if (line.trim() === '') continue;
                        try {
                            const parts = [];
                            let inQuote = false;
                            let currentField = '';
                            for (let j = 0; j < line.length; j++) {
                                const char = line[j];
                                if (char === '"') {
                                    // Handle escaped double quote "" inside a field
                                    if (j < line.length - 1 && line[j+1] === '"' && inQuote) {
                                        currentField += '"';
                                        j++; // Skip the next quote as it's part of the escape sequence
                                    } else {
                                        inQuote = !inQuote;
                                    }
                                } else if (char === ',' && !inQuote) {
                                    parts.push(currentField);
                                    currentField = '';
                                } else {
                                    currentField += char;
                                }
                            }
                            parts.push(currentField); // Add the last field

                            // At this point, 'parts' contains the raw, potentially quoted/escaped fields.
                            // We need to unquote and unescape them.
                            const cleanedParts = parts.map(p => {
                                // If the field starts and ends with a quote, remove them and unescape internal quotes
                                if (p.startsWith('"') && p.endsWith('"') && p.length >= 2) {
                                    return p.substring(1, p.length - 1).replace(/""/g, '"');
                                }
                                return p;
                            }).map(p => p.trim()); // Trim whitespace from each part

                            // Ensure all expected headers are present in the CSV and use their mapped indices
                            const idIndex = headerMap['id'];
                            const fechaIndex = headerMap['fecha'];
                            const tipoIndex = headerMap['tipo'];
                            const productoIndex = headerMap['producto'];
                            const cantidadIndex = headerMap['cantidad'];
                            const operariosIndex = headerMap['operarios'];
                            const comentariosIndex = headerMap['comentarios'];

                            if (idIndex === -1 || fechaIndex === -1 || tipoIndex === -1 || productoIndex === -1 || cantidadIndex === -1 || operariosIndex === -1 || comentariosIndex === -1) {
                                throw new Error('faltan columnas esenciales en el archivo CSV.');
                            }

                            const novedad = {
                                id: parseInt(cleanedParts[idIndex]) || Date.now() + i, 
                                fecha: cleanedParts[fechaIndex],
                                tipo: cleanedParts[tipoIndex],
                                producto: cleanedParts[productoIndex],
                                cantidad: parseFloat(cleanedParts[cantidadIndex]),
                                operarios: parseInt(cleanedParts[operariosIndex]),
                                comentarios: cleanedParts[comentariosIndex] || '',
                            };

                            if (isNaN(novedad.cantidad) || isNaN(novedad.operarios)) {
                                throw new Error('valores de cantidad u operarios no válidos.');
                            }
                            
                            if (!novedad.fecha || !novedad.tipo || !novedad.producto) {
                                throw new Error('faltan datos clave (fecha, tipo o producto).');
                            }

                            novedadesToCommit.push(novedad); // Add to a temporary list for committing
                            successfullyProcessedLines++; // Increment count for *processed* lines
                        } catch (error) {
                            importErrors.push(`Línea ${i + 1}: ${error.message}`);
                            console.error(`Error en la línea ${i + 1}: ${error.message}`);
                        }
                    }

                    // Now, commit only the successfully processed lines to Firestore
                    if (novedadesToCommit.length > 0) {
                        const novedadesColRef = collection(window.db, getCollectionPath('novedades_collection'));
                        const addPromises = novedadesToCommit.map(novedad => addDoc(novedadesColRef, novedad));
                        await Promise.all(addPromises);
                        refreshUI(); 

                        let message = '';
                        if (cancelImport) {
                            message = `Importación cancelada. Se cargaron ${successfullyProcessedLines} registros.`;
                        } else {
                            message = `Se han importado ${novedadesToCommit.length} registros exitosamente.`;
                        }
                        
                        if (importErrors.length > 0) {
                            message += `<br><br><b>Se encontraron ${importErrors.length} errores:</b><br>${importErrors.join('<br>')}`;
                        }
                        showLLMOutput('Importación Finalizada', message);
                    } else if (cancelImport) {
                        showLLMOutput('Importación Cancelada', `No se cargó ningún registro antes de la cancelación.`);
                    } else {
                        showLLMOutput('Importación Fallida', 'No se encontraron registros válidos para importar en el archivo. Asegúrate de que el formato sea correcto y los datos sean válidos.');
                    }
                } catch (generalError) {
                    console.error("Error general durante la importación CSV:", generalError);
                    showLLMOutput('Error Crítico de Importación', `Ocurrió un error inesperado durante el procesamiento del archivo: ${generalError.message}`);
                } finally {
                    hideLoading(); // Always hide loading overlay
                }
            };
            reader.readAsText(file);
        };

        document.getElementById('export-btn').addEventListener('click', exportToCsv);
        document.getElementById('refresh-btn').addEventListener('click', () => {
            refreshUI(); 
            showLLMOutput('Dashboard Actualizado', 'El panel de control ha sido refrescado.');
        });
        document.getElementById('import-btn').addEventListener('click', () => {
            document.getElementById('csv-file').click();
        });
        document.getElementById('csv-file').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) importFromCsv(file);
        });

        // Prices Maintenance Logic
        const priceModal = document.getElementById('price-modal');
        const priceForm = document.getElementById('price-form');

        const openPriceModal = (product) => {
            const config = productConfig[product] || { kgFactor: 0, pricePerKg: 0 };
            document.getElementById('price-product-name').value = product;
            document.getElementById('price-kg-factor').value = config.kgFactor;
            document.getElementById('price-price-per-kg').value = config.pricePerKg;
            openModal(priceModal);
        };

        const closePriceModal = () => closeModal(priceModal);

        document.getElementById('prices-table-body').addEventListener('click', (e) => {
            if (e.target.classList.contains('edit-price-btn')) {
                const product = e.target.dataset.product;
                openPriceModal(product);
            }
        });

        document.getElementById('price-cancel-btn').addEventListener('click', closePriceModal);

        priceForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const product = document.getElementById('price-product-name').value;
            const kgFactor = parseFloat(document.getElementById('price-kg-factor').value);
            const pricePerKg = parseFloat(document.getElementById('price-price-per-kg').value);
            
            if (!isNaN(kgFactor) && !isNaN(pricePerKg)) {
                showLoading();
                try {
                    productConfig[product] = { kgFactor, pricePerKg };
                    await saveProductConfigToFirestore();
                } catch (error) {
                    console.error("Error al guardar configuración de producto en Firestore:", error);
                    showLLMOutput('Error', 'Hubo un error al guardar la configuración del producto. Inténtalo de nuevo.');
                } finally {
                    hideLoading();
                    closePriceModal();
                }
            }
        });

        // Bag Peso Logic
        const bolsaPesoInput = document.getElementById('bolsa-peso');
        const saveBolsaBtn = document.getElementById('save-bolsa-btn');
        
        bolsaPesoInput.value = bolsaPeso;

        saveBolsaBtn.addEventListener('click', async () => {
            const newPeso = parseFloat(bolsaPesoInput.value);
            if (!isNaN(newPeso) && newPeso > 0) {
                showLoading();
                try {
                    bolsaPeso = newPeso;
                    await saveProductConfigToFirestore(); // Update bolsaPeso via the same config doc
                } catch (error) {
                    console.error("Error al guardar peso de bolsa en Firestore:", error);
                    showLLMOutput('Error', 'Hubo un error al guardar el peso de la bolsa. Inténtalo de nuevo.');
                } finally {
                    hideLoading();
                }
            } else {
                showLLMOutput('Valor Inválido', 'Por favor, ingresa un valor válido para el peso de la bolsa.');
            }
        });

        // Navigation Logic
        const dashboardSection = document.getElementById('dashboard-section');
        const pricesSection = document.getElementById('prices-section');
        const navDashboardBtn = document.getElementById('nav-dashboard');
        const navPricesBtn = document.getElementById('nav-prices');
        const headerSubtitle = document.getElementById('header-subtitle');
        const addBtn = document.getElementById('add-btn');

        const showSection = (sectionId) => {
            dashboardSection.classList.add('hidden');
            pricesSection.classList.add('hidden');
            document.getElementById(sectionId).classList.remove('hidden');

            navDashboardBtn.classList.remove('bg-blue-600', 'text-white');
            navDashboardBtn.classList.add('bg-gray-200', 'text-gray-700');
            navPricesBtn.classList.remove('bg-blue-600', 'text-white');
            navPricesBtn.classList.add('bg-gray-200', 'text-gray-700');
            
            if (sectionId === 'dashboard-section') {
                navDashboardBtn.classList.add('bg-blue-600', 'text-white');
                headerSubtitle.textContent = 'Visualiza y gestiona las novedades diarias de materiales y Producción.';
                addBtn.classList.remove('hidden');
            } else {
                navPricesBtn.classList.add('bg-blue-600', 'text-white');
                headerSubtitle.textContent = 'Actualiza los factores de conversión y precios de los productos, y configura notificaciones.';
                addBtn.classList.add('hidden');
            }
        };
        
        navDashboardBtn.addEventListener('click', () => showSection('dashboard-section'));
        navPricesBtn.addEventListener('click', () => showSection('prices-section'));

        // --- Gemini API Integration for generating improvement ideas ---
        const generateIdeasBtn = document.getElementById('generate-ideas-btn');

        generateIdeasBtn.addEventListener('click', async () => {
            const dataToAnalyze = filterAndSortData(); // Get currently filtered data
            if (dataToAnalyze.length === 0) {
                showLLMOutput('Generar Ideas', 'No hay datos de novedades para analizar. Intenta ajustar tus filtros o añadir nuevas novedades.');
                return;
            }

            // Summarize the data for the LLM
            const novedadesSample = dataToAnalyze.slice(0, 20).map(n => { // Limit to 20 recent entries
                const processed = calculateFields(n); // Ensure calculated fields are available for context
                return `- Fecha: ${new Date(n.fecha + 'T00:00:00').toLocaleDateString('es-AR')}, Tipo: ${n.tipo}, Producto: ${n.producto}, Cantidad: ${formatNumber(n.cantidad)}, KG Netos: ${formatNumber(processed.kgNetos)}, Comentarios: ${n.comentarios || 'N/A'}`;
            }).join('\n');

            const kpiSummary = `
- Producción Total (KG): ${document.getElementById('kpi-total-kg').textContent}
- Bolsas Producidas: ${document.getElementById('kpi-bags-produced').textContent}
- Bolsas Entregadas: ${document.getElementById('kpi-bags-delivered').textContent}
- Stock Estimado (Bolsas): ${document.getElementById('kpi-stock-bags').textContent}
- Valor de Producción ($): ${document.getElementById('kpi-total-value').textContent}
- Material Ingresado (KG): ${document.getElementById('kpi-material-in').textContent}
- Cuentas por Cobrar ($): ${document.getElementById('kpi-pending-payment').textContent}
- Stock Est. Policarbonato (KG): ${document.getElementById('kpi-stock-molido').textContent}
- Producción Pellets (KG): ${document.getElementById('kpi-pellets-kg').textContent}
- Producción Molido (KG): ${document.getElementById('kpi-molido-kg').textContent}
- Producción Total ($): ${document.getElementById('kpi-total-value-produced').textContent}
            `;

            showLoading('Generando Ideas...'); // Show generic loading for AI
            showLLMOutput('Generando Ideas...', 'La IA de Gemini está analizando tus datos. Esto puede tomar unos segundos.'); // This is shown on top of loading, should be reversed.

            const apiKey = ""; // Canvas will provide this
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            let responseText = '';
            let retries = 0;
            const maxRetries = 3;
            const baseDelay = 1000; // 1 second

            try { // Added try-catch for the AI call
                while (retries < maxRetries) {
                    try {
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(`API error: ${response.status} ${response.statusText} - ${JSON.stringify(errorData)}`);
                        }

                        const result = await response.json();
                        const candidate = result.candidates?.[0];

                        if (candidate && candidate.content?.parts?.[0]?.text) {
                            responseText = candidate.content.parts[0].text;
                            break; // Success, exit loop
                        } else {
                            throw new Error("No se pudo obtener una respuesta válida de la IA. Inténtalo de nuevo.");
                        }
                    } catch (error) {
                        console.error(`Intento ${retries + 1} fallido:`, error);
                        retries++;
                        if (retries < maxRetries) {
                            const delay = baseDelay * Math.pow(2, retries); // Exponential backoff
                            await new Promise(resolve => setTimeout(resolve, delay));
                            // Only update message if it's the current active message (not LLM output)
                            if (loadingOverlay.classList.contains('hidden') === false) { // Check if loading is still active
                                loadingMessage.textContent = `Error al generar ideas, reintentando en ${delay / 1000} segundos...`;
                            }
                        } else {
                            responseText = 'No se pudo generar ideas de mejora en este momento. Por favor, intenta de nuevo más tarde.';
                        }
                    }
                }
            } catch (aiCallError) {
                console.error("Error durante la llamada a la API de Gemini:", aiCallError);
                responseText = 'Ocurrió un error al conectar con el servicio de IA. Por favor, inténtalo de nuevo más tarde.';
            } finally {
                hideLoading(); // Hide loading after the AI call
                showLLMOutput('Ideas de Mejora Sugeridas', responseText);
            }
        });
        // --- End Gemini API Integration ---

        // --- Firebase Data Listeners ---
        const setupFirestoreListeners = () => {
            if (!window.db || !window.userId) {
                console.warn("Firestore or userId not available yet for listeners setup.");
                return;
            }

            // Novedades Listener
            const novedadesColRef = collection(window.db, getCollectionPath('novedades_collection'));
            onSnapshot(query(novedadesColRef), (snapshot) => {
                const fetchedNovedades = [];
                snapshot.forEach(doc => {
                    fetchedNovedades.push({ ...doc.data(), firestoreId: doc.id });
                });
                novedades = fetchedNovedades;
                refreshUI(); // Refresh UI on any data change
            }, (error) => {
                console.error("Error fetching novedades:", error);
                showLLMOutput('Error de Sincronización', 'No se pudieron cargar las novedades. Comprueba tu conexión a Internet.');
            });

            // Product Config Listener
            const configDocRef = doc(window.db, getCollectionPath('product_config_collection'), 'settings');
            onSnapshot(configDocRef, async (docSnapshot) => {
                if (docSnapshot.exists()) {
                    const data = docSnapshot.data();
                    productConfig = data.config || {};
                    bolsaPeso = data.bolsaPeso !== undefined ? data.bolsaPeso : 25;
                } else {
                    // Initialize if not exists, for first-time users
                    console.log("Product config not found in Firestore, initializing with defaults.");
                    productConfig = {
                        'Pellets': { kgFactor: 1, pricePerKg: 275 },
                        'Molido Policarbonato': { kgFactor: 75, pricePerKg: 200 },
                        'Bidones 12L': { kgFactor: 0.5, pricePerKg: 250 },
                        'Bidones 20L': { kgFactor: 0.85, pricePerKg: 300 },
                        'Tapas': { kgFactor: 1, pricePerKg: 150 },
                        'Egreso Pellets': { kgFactor: 1, pricePerKg: 275 },
                        'Egreso Molido Policarbonato': { kgFactor: 75, pricePerKg: 200 },
                        'Pendiente de Cobro': { kgFactor: 0, pricePerKg: 1 },
                        'Cobro de Pendiente': { kgFactor: 0, pricePerKg: 1 },
                    };
                    bolsaPeso = 25;
                    // Persist to Firestore
                    await saveProductConfigToFirestore(); 
                }
                refreshUI(); // Refresh UI on config change
            }, (error) => {
                console.error("Error fetching product config:", error);
                showLLMOutput('Error de Sincronización', 'No se pudo cargar la configuración de productos. Comprueba tu conexión a Internet.');
            });

            // Audit Log Listener
            const auditColRef = collection(window.db, getCollectionPath('audit_log_collection'));
            onSnapshot(query(auditColRef), (snapshot) => {
                const fetchedAuditLog = [];
                snapshot.forEach(doc => {
                    fetchedAuditLog.push({ ...doc.data(), firestoreId: doc.id });
                });
                auditLog = fetchedAuditLog.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                refreshUI(); // Refresh UI on audit log change
            }, (error) => {
                console.error("Error fetching audit log:", error);
                showLLMOutput('Error de Sincronización', 'No se pudo cargar el historial de auditoría. Comprueba tu conexión a Internet.');
            });
            // Initial UI refresh will be triggered by the first snapshots of the listeners.
            // No need to hide loading here, as the listeners will eventually trigger a refresh.
            // If all three listeners have fired at least once, then hideLoading can be called.
            // For now, let's keep it in each listener's initial load path if there was no existing data.
        };

        // Wait for Firebase Auth to be ready before setting up listeners
        document.addEventListener('firebaseAuthReady', () => {
            setupFirestoreListeners();
            showSection('dashboard-section');
            populateMonthSelect();
            populateProductSelect(); // Ensure products are populated on initial load
            document.getElementById('month-select').value = selectedMonth;
            document.getElementById('product-select').value = selectedProduct;
            // The initial refreshUI will be called by the onSnapshot listeners once data is fetched.
            hideLoading(); // Hide loading after listeners are set up and initial data should be flowing
        });

        // Show loading immediately when the script starts
        showLoading();
    </script>
</body>
</html>
