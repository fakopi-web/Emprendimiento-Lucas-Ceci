<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Control de Producción</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Warm Neutrals with Blue Accent -->
    <!-- Application Structure Plan: Se ha diseñado una aplicación de una sola página con un enfoque de dashboard. La estructura principal separa la visualización de datos de la entrada de datos para una mejor experiencia de usuario. La vista principal contiene: 1) KPIs (Indicadores Clave de Rendimiento) para un resumen rápido. 2) Filtros de tiempo interactivos (Mes, Semana, etc.). 3) Gráficos dinámicos para análisis visual de la producción y valor. 4) Una tabla detallada y paginada de todas las novedades. Un botón flotante abre un modal para añadir o editar registros. Esta arquitectura fue elegida porque prioriza el consumo de información (el objetivo principal de un dashboard) y encapsula la acción de entrada de datos en un flujo separado y controlado, mejorando la usabilidad y reduciendo errores en comparación con una tabla editable gigante. -->
    <!-- Visualization & Content Choices: 1) KPIs: Informar rápidamente sobre totales. Se usan tarjetas de texto dinámico. 2) Gráfico de Barras (Producción por Producto): Comparar el rendimiento entre diferentes líneas de producto. Interacción: Tooltip al pasar el mouse. Se usa Chart.js. 3) Gráfico de Líneas (Producción en el Tiempo): Mostrar tendencias y cambios. Interacción: Tooltip. Se usa Chart.js. 4) Tabla de Novedades: Organizar y mostrar todos los detalles. Interacción: Ordenar, editar, eliminar. Se usa HTML/JS. 5) Formulario Modal: Para la entrada de datos estructurada. Interacción: Listas desplegables dependientes. Se usa HTML/JS. Esta selección de elementos interactivos convierte los datos estáticos de la planilla en una herramienta de análisis dinámica. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body { font-family: 'Inter', sans-serif; }
        .chart-container { position: relative; width: 100%; max-width: 800px; margin-left: auto; margin-right: auto; height: 300px; max-height: 400px; }
        @media (min-width: 768px) { .chart-container { height: 350px; } }
        .modal { transition: opacity 0.25s ease; }
        .modal-content { transition: transform 0.25s ease; }
        .table-cell { white-space: nowrap; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="app" class="p-4 sm:p-6 lg:p-8 max-w-7xl mx-auto">

        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900">Panel de Control de Producción</h1>
            <p class="text-gray-600 mt-1">Visualiza y gestiona las novedades diarias de materiales y producción.</p>
        </header>

        <main>
            <!-- KPIs Section -->
            <section id="kpis" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                    <h3 class="text-sm font-medium text-gray-500">Producción Total (KG)</h3>
                    <p id="kpi-total-kg" class="text-3xl font-bold text-gray-900 mt-2">0</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                    <h3 class="text-sm font-medium text-gray-500">Valor de Producción ($)</h3>
                    <p id="kpi-total-value" class="text-3xl font-bold text-gray-900 mt-2">0</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                    <h3 class="text-sm font-medium text-gray-500">Material Ingresado (KG)</h3>
                    <p id="kpi-material-in" class="text-3xl font-bold text-gray-900 mt-2">0</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                    <h3 class="text-sm font-medium text-gray-500">Cuentas por Cobrar ($)</h3>
                    <p id="kpi-pending-payment" class="text-3xl font-bold text-gray-900 mt-2">0</p>
                </div>
            </section>

            <!-- Filters and Charts Section -->
            <section class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 mb-8">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-900 mb-4 sm:mb-0">Análisis de Novedades</h2>
                    <div id="time-filters" class="flex items-center space-x-2">
                        <button data-filter="week" class="filter-btn bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium">Últimos 7 días</button>
                        <button data-filter="month" class="filter-btn bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium">Este Mes</button>
                        <button data-filter="all" class="filter-btn bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium">Todos</button>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div>
                        <h3 class="text-lg font-semibold text-center mb-2">Producción (KG) por Producto</h3>
                        <p class="text-sm text-gray-500 text-center mb-4">Compara la cantidad total producida de cada línea de producto.</p>
                        <div class="chart-container h-80 md:h-96">
                            <canvas id="productionByProductChart"></canvas>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-center mb-2">Valor ($) por Producto</h3>
                        <p class="text-sm text-gray-500 text-center mb-4">Distribución del valor monetario generado por cada producto.</p>
                        <div class="chart-container h-80 md:h-96">
                            <canvas id="valueByProductChart"></canvas>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Data Table Section -->
            <section id="data-table-section" class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                 <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-900">Registro de Novedades</h2>
                     <p class="text-sm text-gray-600 mt-1 sm:mt-0">Aquí puedes ver, editar o eliminar cada una de las novedades registradas.</p>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Producto/Línea</th>
                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">KG Netos</th>
                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">$ en Pesos</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Indicador</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="novedades-table-body" class="bg-white divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <!-- Add/Edit Modal -->
    <div id="form-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0">
        <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-lg p-8 transform -translate-y-10">
            <h2 id="modal-title" class="text-2xl font-bold mb-6">Nueva Novedad</h2>
            <form id="novedad-form">
                <input type="hidden" id="novedad-id">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                    <div>
                        <label for="fecha" class="block text-sm font-medium text-gray-700">Fecha</label>
                        <input type="date" id="fecha" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="tipo" class="block text-sm font-medium text-gray-700">Tipo</label>
                        <select id="tipo" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </select>
                    </div>
                    <div class="sm:col-span-2">
                        <label for="producto" class="block text-sm font-medium text-gray-700">Producto o Línea</label>
                        <select id="producto" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </select>
                    </div>
                    <div>
                        <label for="cantidad" class="block text-sm font-medium text-gray-700">Cantidad / Kg / Pesos</label>
                        <input type="number" id="cantidad" step="0.01" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="operarios" class="block text-sm font-medium text-gray-700">Operarios</label>
                        <input type="number" id="operarios" value="0" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="sm:col-span-2">
                        <label for="comentarios" class="block text-sm font-medium text-gray-700">Comentarios</label>
                        <textarea id="comentarios" rows="3" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                    </div>
                </div>
                <div class="mt-8 flex justify-end space-x-4">
                    <button type="button" id="cancel-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-medium">Cancelar</button>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Button -->
    <button id="add-btn" class="fixed bottom-8 right-8 bg-blue-600 text-white rounded-full p-4 shadow-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg>
    </button>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const initialData = [
                { id: 1, fecha: '2025-08-01', tipo: 'Producción Diurna', producto: 'Pellets', cantidad: 550, operarios: 4, comentarios: 'Producción estándar.' },
                { id: 2, fecha: '2025-08-01', tipo: 'Producción Diurna', producto: 'Molido Policarbonato', cantidad: 10, operarios: 2, comentarios: '10 bandejas.' },
                { id: 3, fecha: '2025-08-02', tipo: 'Novedades Diurna', producto: 'Bidones 20L', cantidad: 200, operarios: 1, comentarios: 'Recepción de material.' },
                { id: 4, fecha: '2025-08-03', tipo: 'Egreso Producción', producto: 'Egreso Pellets', cantidad: 500, operarios: 1, comentarios: 'Entrega a cliente A.' },
                { id: 5, fecha: '2025-08-03', tipo: 'Pendiente de Cobro', producto: 'Pendiente de Cobro', cantidad: 20000, operarios: 0, comentarios: 'Cliente A.' },
                { id: 6, fecha: '2025-08-10', tipo: 'Cobro de Pendiente', producto: 'Cobro de Pendiente', cantidad: 20000, operarios: 0, comentarios: 'Saldo de cliente A.' },
                { id: 7, fecha: '2025-08-12', tipo: 'Producción Nocturna', producto: 'Pellets', cantidad: 480, operarios: 3, comentarios: '' },
                { id: 8, fecha: '2025-08-15', tipo: 'Producción Diurna', producto: 'Molido Policarbonato', cantidad: 15, operarios: 2, comentarios: '15 bandejas.' },
            ];

            let novedades = JSON.parse(localStorage.getItem('novedades')) || initialData;
            let currentFilter = 'month';
            let productionByProductChart, valueByProductChart;

            const options = {
                tipo: {
                    'Producción Diurna': ['Pellets', 'Molido Policarbonato'],
                    'Producción Nocturna': ['Pellets', 'Molido Policarbonato'],
                    'Novedades Diurna': ['Bidones 12L', 'Bidones 20L', 'Tapas'],
                    'Novedades Nocturna': ['Bidones 12L', 'Bidones 20L', 'Tapas'],
                    'Egreso Producción': ['Egreso Pellets', 'Egreso Molido Policarbonato'],
                    'Pendiente de Cobro': ['Pendiente de Cobro'],
                    'Cobro de Pendiente': ['Cobro de Pendiente'],
                }
            };

            const formatCurrency = (value) => new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS' }).format(value);
            const formatNumber = (value) => new Intl.NumberFormat('es-AR').format(value);

            const calculateFields = (novedad) => {
                let kgNetos = 0;
                let valor = 0;
                let bolsas = 0;
                let indicador = 'N';

                const { tipo, producto, cantidad } = novedad;

                switch (producto) {
                    case 'Pellets':
                    case 'Egreso Pellets':
                    case 'Tapas':
                        kgNetos = cantidad;
                        break;
                    case 'Molido Policarbonato':
                    case 'Egreso Molido Policarbonato':
                        kgNetos = cantidad * 75;
                        break;
                    case 'Bidones 12L':
                        kgNetos = cantidad * 0.5;
                        break;
                    case 'Bidones 20L':
                        kgNetos = cantidad * 0.85;
                        break;
                    default:
                        kgNetos = 0;
                }

                if (producto === 'Pellets') {
                    valor = kgNetos * 275;
                    bolsas = Math.ceil(kgNetos / 25);
                } else if (producto === 'Molido Policarbonato') {
                    valor = kgNetos * 200;
                } else if (tipo === 'Pendiente de Cobro' || tipo === 'Cobro de Pendiente') {
                    valor = cantidad;
                }
                
                if (tipo.includes('Producción')) indicador = 'P';
                if (tipo.includes('Egreso')) indicador = 'E';

                return { ...novedad, kgNetos, valor, bolsas, indicador };
            };

            const saveNovedades = () => {
                localStorage.setItem('novedades', JSON.stringify(novedades));
            };

            const renderTable = (data) => {
                const tableBody = document.getElementById('novedades-table-body');
                tableBody.innerHTML = data.map(n => {
                    const processed = calculateFields(n);
                    return `
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-3 table-cell">${new Date(n.fecha + 'T00:00:00').toLocaleDateString('es-AR')}</td>
                            <td class="px-4 py-3 table-cell">${n.tipo}</td>
                            <td class="px-4 py-3 table-cell">${n.producto}</td>
                            <td class="px-4 py-3 table-cell text-right">${formatNumber(processed.kgNetos)}</td>
                            <td class="px-4 py-3 table-cell text-right">${formatCurrency(processed.valor)}</td>
                            <td class="px-4 py-3 table-cell text-center">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${processed.indicador === 'P' ? 'bg-green-100 text-green-800' : processed.indicador === 'E' ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800'}">
                                    ${processed.indicador}
                                </span>
                            </td>
                            <td class="px-4 py-3 table-cell text-center">
                                <button class="edit-btn text-blue-600 hover:text-blue-900" data-id="${n.id}">Editar</button>
                                <button class="delete-btn text-red-600 hover:text-red-900 ml-2" data-id="${n.id}">Eliminar</button>
                            </td>
                        </tr>
                    `;
                }).join('');
            };

            const renderKPIs = (data) => {
                const processedData = data.map(calculateFields);
                const totalKg = processedData.filter(n => n.tipo.includes('Producción')).reduce((sum, n) => sum + n.kgNetos, 0);
                const totalValue = processedData.filter(n => n.tipo.includes('Producción')).reduce((sum, n) => sum + n.valor, 0);
                const materialIn = processedData.filter(n => n.tipo.includes('Novedades')).reduce((sum, n) => sum + n.kgNetos, 0);
                const pendingPayment = processedData.reduce((sum, n) => {
                    if (n.tipo === 'Pendiente de Cobro') return sum + n.valor;
                    if (n.tipo === 'Cobro de Pendiente') return sum - n.valor;
                    return sum;
                }, 0);

                document.getElementById('kpi-total-kg').textContent = formatNumber(totalKg);
                document.getElementById('kpi-total-value').textContent = formatCurrency(totalValue);
                document.getElementById('kpi-material-in').textContent = formatNumber(materialIn);
                document.getElementById('kpi-pending-payment').textContent = formatCurrency(pendingPayment);
            };

            const renderCharts = (data) => {
                const processedData = data.map(calculateFields).filter(n => n.tipo.includes('Producción'));
                
                const productionByProduct = processedData.reduce((acc, n) => {
                    acc[n.producto] = (acc[n.producto] || 0) + n.kgNetos;
                    return acc;
                }, {});

                const valueByProduct = processedData.reduce((acc, n) => {
                    acc[n.producto] = (acc[n.producto] || 0) + n.valor;
                    return acc;
                }, {});

                const chartColors = ['#3b82f6', '#10b981', '#f97316', '#8b5cf6'];

                const prodCtx = document.getElementById('productionByProductChart').getContext('2d');
                if (productionByProductChart) productionByProductChart.destroy();
                productionByProductChart = new Chart(prodCtx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(productionByProduct),
                        datasets: [{
                            label: 'Producción (KG)',
                            data: Object.values(productionByProduct),
                            backgroundColor: chartColors,
                            borderColor: chartColors.map(c => c + 'B3'),
                            borderWidth: 1
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
                });

                const valueCtx = document.getElementById('valueByProductChart').getContext('2d');
                if (valueByProductChart) valueByProductChart.destroy();
                valueByProductChart = new Chart(valueCtx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(valueByProduct),
                        datasets: [{
                            data: Object.values(valueByProduct),
                            backgroundColor: chartColors,
                            hoverOffset: 4
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            };

            const filterData = () => {
                const now = new Date();
                if (currentFilter === 'all') return novedades;
                
                const filterDate = new Date();
                if (currentFilter === 'week') {
                    filterDate.setDate(now.getDate() - 7);
                } else if (currentFilter === 'month') {
                    filterDate.setMonth(now.getMonth(), 1);
                    filterDate.setHours(0,0,0,0);
                }
                
                return novedades.filter(n => new Date(n.fecha) >= filterDate);
            };
            
            const refreshUI = () => {
                const filtered = filterData();
                renderTable(filtered);
                renderKPIs(novedades);
                renderCharts(filtered);
            };

            const modal = document.getElementById('form-modal');
            const form = document.getElementById('novedad-form');
            const tipoSelect = document.getElementById('tipo');
            const productoSelect = document.getElementById('producto');

            const openModal = (novedad = null) => {
                form.reset();
                document.getElementById('novedad-id').value = '';
                if (novedad) {
                    document.getElementById('modal-title').textContent = 'Editar Novedad';
                    document.getElementById('novedad-id').value = novedad.id;
                    document.getElementById('fecha').value = novedad.fecha;
                    tipoSelect.value = novedad.tipo;
                    updateProductoOptions();
                    productoSelect.value = novedad.producto;
                    document.getElementById('cantidad').value = novedad.cantidad;
                    document.getElementById('operarios').value = novedad.operarios;
                    document.getElementById('comentarios').value = novedad.comentarios;
                } else {
                    document.getElementById('modal-title').textContent = 'Nueva Novedad';
                    document.getElementById('fecha').valueAsDate = new Date();
                }
                modal.classList.remove('hidden');
                setTimeout(() => {
                    modal.classList.remove('opacity-0');
                    modal.querySelector('.modal-content').classList.remove('-translate-y-10');
                }, 10);
            };

            const closeModal = () => {
                modal.classList.add('opacity-0');
                modal.querySelector('.modal-content').classList.add('-translate-y-10');
                setTimeout(() => modal.classList.add('hidden'), 250);
            };

            const updateProductoOptions = () => {
                const selectedTipo = tipoSelect.value;
                const productos = options.tipo[selectedTipo] || [];
                productoSelect.innerHTML = productos.map(p => `<option value="${p}">${p}</option>`).join('');
            };

            Object.keys(options.tipo).forEach(tipo => {
                tipoSelect.innerHTML += `<option value="${tipo}">${tipo}</option>`;
            });
            updateProductoOptions();

            tipoSelect.addEventListener('change', updateProductoOptions);
            document.getElementById('add-btn').addEventListener('click', () => openModal());
            document.getElementById('cancel-btn').addEventListener('click', closeModal);
            
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                const id = document.getElementById('novedad-id').value;
                const newNovedad = {
                    id: id ? parseInt(id) : Date.now(),
                    fecha: document.getElementById('fecha').value,
                    tipo: tipoSelect.value,
                    producto: productoSelect.value,
                    cantidad: parseFloat(document.getElementById('cantidad').value),
                    operarios: parseInt(document.getElementById('operarios').value),
                    comentarios: document.getElementById('comentarios').value,
                };

                if (id) {
                    novedades = novedades.map(n => n.id === newNovedad.id ? newNovedad : n);
                } else {
                    novedades.push(newNovedad);
                }
                saveNovedades();
                refreshUI();
                closeModal();
            });

            document.getElementById('novedades-table-body').addEventListener('click', (e) => {
                const id = parseInt(e.target.dataset.id);
                if (e.target.classList.contains('edit-btn')) {
                    const novedadToEdit = novedades.find(n => n.id === id);
                    openModal(novedadToEdit);
                }
                if (e.target.classList.contains('delete-btn')) {
                    if (confirm('¿Estás seguro de que quieres eliminar este registro?')) {
                        novedades = novedades.filter(n => n.id !== id);
                        saveNovedades();
                        refreshUI();
                    }
                }
            });

            document.getElementById('time-filters').addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    currentFilter = e.target.dataset.filter;
                    document.querySelectorAll('.filter-btn').forEach(btn => {
                        btn.classList.remove('bg-blue-600', 'text-white');
                        btn.classList.add('bg-gray-200', 'text-gray-700');
                    });
                    e.target.classList.add('bg-blue-600', 'text-white');
                    e.target.classList.remove('bg-gray-200', 'text-gray-700');
                    refreshUI();
                }
            });

            refreshUI();
        });
    </script>
</body>
</html>
